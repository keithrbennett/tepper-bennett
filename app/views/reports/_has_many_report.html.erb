<% fn_name = ->(primary) { n = primary[:name]; (n == n.downcase ? n : n.capitalize) } %>

<% records.each do |primary| %>
  <% secondaries = primary[secondary_key].pluck(:code, :name) %>
  <% locals =  { column_headings: headings, name: fn_name.(primary), secondaries: secondaries } %>
  <%= render(partial: 'reports/has_many_report_section', locals: locals) %>
<% end %>
